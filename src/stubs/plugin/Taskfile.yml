version: '3'

includes:
  utils: vendor/yootheme/starter-utils

vars:
  NAME: '{{ TITLE }}'
  VERSION: '0.0.1'
  DESCRIPTION: '{{ DESCRIPTION }}'
  DATE: '{{ now | date "2006-01-02" }}'
  COPYRIGHT: 'Copyright (C)'
  LICENSE: 'GNU General Public License'
  AUTHOR: '{{ AUTHOR }}'
  AUTHOREMAIL: '{{ AUTHOREMAIL }}'
  AUTHORURL: '{{ AUTHORURL }}'

tasks:
  build:
    deps:
      - for: [joomla, wordpress]
        task: build-{{.ITEM}}

  build-joomla:
    cmds:
      - task: utils:copy
        vars:
          cwd: build/joomla
          src: '**'
          dest: dist/joomla

      - task: copy-module
        vars:
          SYSTEM: joomla

      - task: copy-elements
        vars:
          SYSTEM: joomla

      - task: placeholder-joomla

      - task: utils:zip
        vars:
          cwd: dist/joomla
          src: '**'
          dest: dist/{{.NAME}}-{{.VERSION}}.zip

      #- defer:
      #    task: clear-dist-joomla

  build-wordpress:
    cmds:
      - task: utils:copy
        vars:
          cwd: build/wordpress
          src: '*.php'
          dest: dist/wordpress

      - task: copy-module
        vars:
          SYSTEM: wordpress

      - task: copy-elements
        vars:
          SYSTEM: wordpress

      - task: placeholder-wordpress

      - task: utils:zip
        vars:
          cwd: dist/wordpress
          src: '**'
          dest: dist/wp-{{.NAME}}-{{.VERSION}}.zip

      - defer:
          task: clear-dist-wordpress

  copy-module:
    internal: true
    cmds:
      - task: utils:copy
        vars:
          src: 'bootstrap.php'
          dest: dist/{{.SYSTEM}}

  copy-elements:
    internal: true
    cmds:
      - task: utils:copy
        vars:
          cwd: elements
          src: '**'
          dest: dist/{{.SYSTEM}}/elements

  placeholder-joomla:
    internal: true
    cmds:
      - task: utils:placeholder
        vars:
          src: 'dist/joomla/**/*.xml'
          replace:
            ref: >
              dict
              "AUTHOR" "{{.AUTHOR}}"
              "AUTHOREMAIL" "{{.AUTHOREMAIL}}"
              "AUTHORURL" "{{.AUTHORURL}}"
              "COPYRIGHT" "{{.COPYRIGHT}}"
              "DATE" "{{.DATE}}"
              "DESCRIPTION" "{{.DESCRIPTION}}"
              "LICENSE" "{{.LICENSE}}"
              "NAME" "{{.NAME}}"
              "VERSION" "{{.VERSION}}"

  placeholder-wordpress:
    internal: true
    cmds:
      - task: utils:placeholder
        vars:
          src: dist/wordpress/{{.NAME}}.php
          replace:
            ref: >
              dict
              "AUTHOR" "{{.AUTHOR}}"
              "AUTHOREMAIL" "{{.AUTHOREMAIL}}"
              "AUTHORURL" "{{.AUTHORURL}}"
              "COPYRIGHT" "{{.COPYRIGHT}}"
              "DATE" "{{.DATE}}"
              "DESCRIPTION" "{{.DESCRIPTION}}"
              "LICENSE" "{{.LICENSE}}"
              "NAME" "{{.NAME}}"
              "VERSION" "{{.VERSION}}"

  clear-dist-joomla:
    internal: true
    cmds:
      - task: utils:remove
        vars:
          src: dist/joomla

  clear-dist-wordpress:
    internal: true
    cmds:
      - task: utils:remove
        vars:
          src: dist/wordpress

  setup-joomla:
    cmds:
      - task: utils:copy
        vars:
          cwd: build/joomla
          src: '**'
          dest: dist/joomla

      - task: placeholder-joomla

      - task: utils:copy
        vars:
          cwd: dist/joomla
          src: '**'
          dest: ./

      - defer:
          task: clear-dist-joomla

  setup-wordpress:
    cmds:
      - task: utils:copy
        vars:
          cwd: build/wordpress
          src: '*.php'
          dest: dist/wordpress

      - task: placeholder-wordpress

      - task: utils:copy
        vars:
          cwd: dist/wordpress
          src: '**'
          dest: ./

      - defer:
          task: clear-dist-wordpress
